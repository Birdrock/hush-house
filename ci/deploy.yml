---
platform: linux
inputs:
- name: hush-house
- name: helm-values
params:
  DEPLOYMENT:
run:
  path: /bin/bash
  args:
  - -cex
  - |
    apk add --update make curl

    # deployment credentials setup
    cat ./helm-values/.values.yaml > ./hush-house/deployments/$DEPLOYMENT/.values.yaml

    # kubectl credential setup
    mkdir -p ~/.kube
    echo '((kube-config-b64))' | base64 -d >~/.kube/config

    # kubectl setup
    helm init --client-only
    echo '((helm-ca-cert-b64))' | base64 -d > $(helm home)/ca.pem
    echo '((helm-cert-b64))' | base64 -d > $(helm home)/cert.pem
    echo '((helm-key-b64))' | base64 -d > $(helm home)/key.pem


    helm repo remove local
    helm repo add concourse https://raw.githubusercontent.com/concourse/charts/gh-pages
    helm plugin install https://github.com/databus23/helm-diff --version master

    cd ./hush-house/deployments
    make diff-$DEPLOYMENT && \
      echo "No changes!" || \
      { [[ $? == "2" ]] && echo "y" | make deploy-$DEPLOYMENT; }
